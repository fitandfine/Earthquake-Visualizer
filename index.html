<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>üåç Earthquake Visualizer ‚Äì Production</title>

  <!-- Leaflet & plugins CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html,body{height:100%;margin:0;}
    body{font-family:sans-serif;background:#0f172a;color:#e6eef8;}
    .app{display:grid;grid-template-columns:1fr 360px;height:100vh;gap:12px;padding:12px;box-sizing:border-box;}
    #map{width:100%;height:100%;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.6);}
    .sidebar{padding:16px;background:rgba(255,255,255,.05);border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.6);display:flex;flex-direction:column;gap:12px;}
    .sidebar h2{margin:0 0 4px;}
    .filters label{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:0.9rem;}
    .filters input, .filters select{padding:4px 6px;border-radius:4px;border:none;width:120px;}
    button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:600;}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);}
    .stats{margin-top:auto;font-size:.9rem;opacity:.9;}
    .legend div{display:flex;align-items:center;gap:6px;font-size:.85rem;margin-top:2px;}
    .legend span{display:inline-block;width:20px;height:12px;border-radius:2px;}
    #searchPlace{padding:6px;border-radius:6px;border:none;width:100%;margin-top:8px;}
    @media(max-width:900px){.app{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="app">
  <div id="map"></div>

  <aside class="sidebar">
    <h2>üåç Earthquake Visualizer</h2>
    <div class="filters">
      <label>Min Magnitude:<input type="number" id="minMag" min="0" max="10" step="0.1" value="0"></label>
      <label>Max Depth (km):<input type="number" id="maxDepth" min="0" max="700" step="10" value="700"></label>
      <label>Time Frame:
        <select id="timeFrame">
          <option value="all_hour">Last Hour</option>
          <option value="all_day">Last Day</option>
          <option value="all_week">Last Week</option>
        </select>
      </label>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="refresh">üîÑ Refresh</button>
      <button id="toggleHeat" class="ghost">üî• Show Heatmap</button>
    </div>

    <input type="text" id="searchPlace" placeholder="Search by place...">

    <div class="stats">
      Last updated: <span id="lastUpdated">‚Äî</span><br/>
      Earthquakes: <span id="count">‚Äî</span>
    </div>

    <div class="legend">
      <strong>Depth Color Legend:</strong>
      <div><span style="background:#00d084"></span>0-20 km</div>
      <div><span style="background:#ffbf00"></span>20-70 km</div>
      <div><span style="background:#ff6b00"></span>70-300 km</div>
      <div><span style="background:#8b00ff"></span>300+ km</div>
    </div>
  </aside>
</div>

<!-- Leaflet JS + plugins -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
(() => {
  const REFRESH_SECS = 60;

  // DOM references
  const lastUpdated = document.getElementById('lastUpdated');
  const countSpan = document.getElementById('count');
  const refreshBtn = document.getElementById('refresh');
  const toggleHeatBtn = document.getElementById('toggleHeat');
  const minMag = document.getElementById('minMag');
  const maxDepth = document.getElementById('maxDepth');
  const timeFrame = document.getElementById('timeFrame');
  const searchPlace = document.getElementById('searchPlace');

  // Map init
  let map = L.map('map', {preferCanvas:true, minZoom:2, worldCopyJump:true}).setView([20,0],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  let cluster = L.markerClusterGroup();
  let heat = L.heatLayer([], {radius:25, blur:20, maxZoom:6});
  map.addLayer(cluster);

  function depthColor(d){ return d>300?'#8b00ff':d>70?'#ff6b00':d>20?'#ffbf00':'#00d084'; }
  function magRadius(m){ return Math.max(4, m*3); }
  function fmtTime(ms){ return new Date(ms).toLocaleString(); }

  async function fetchData(){
    const FEED = `https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/${timeFrame.value}.geojson`;
    try {
      lastUpdated.textContent='Fetching‚Ä¶';
      const res = await fetch(FEED);
      if(!res.ok) throw new Error(res.statusText);
      const data = await res.json();
      const features = data.features ?? [];

      cluster.clearLayers();
      let heatPoints=[], bounds=[];

      features.forEach(f => {
        if(!f.geometry) return;
        const [lon,lat,depth] = f.geometry.coordinates;
        const mag = f.properties.mag ?? 0;
        const place = f.properties.place ?? '';
        if(mag < parseFloat(minMag.value) || depth > parseFloat(maxDepth.value)) return;
        if(searchPlace.value && !place.toLowerCase().includes(searchPlace.value.toLowerCase())) return;

        const circle = L.circleMarker([lat,lon], {
          radius: magRadius(mag),
          fillColor: depthColor(depth),
          color: '#000',
          weight: 0.3,
          fillOpacity: 0.85,
          opacity: 0.3
        }).bindPopup(`
          <strong>${place}</strong><br/>
          Mag: ${mag} ‚Ä¢ Depth: ${depth} km<br/>
          UTC: ${fmtTime(f.properties.time)}<br/>
          Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)}<br/>
          <a href="${f.properties.url}" target="_blank">More details</a>
        `);

        cluster.addLayer(circle);
        heatPoints.push([lat,lon,Math.min(1,Math.max(0.1,mag/8))]);
        bounds.push([lat,lon]);
      });

      heat.setLatLngs(heatPoints);
      countSpan.textContent = cluster.getLayers().length;
      lastUpdated.textContent = new Date().toLocaleTimeString();
      if(bounds.length) map.fitBounds(bounds,{maxZoom:5,padding:[20,20]});

    } catch(err) {
      console.error(err);
      lastUpdated.textContent='Error';
    }
  }

  // Event listeners
  refreshBtn.onclick = fetchData;
  [minMag,maxDepth,timeFrame,searchPlace].forEach(el => el.addEventListener('change', fetchData));

  toggleHeatBtn.onclick = () => {
    if(map.hasLayer(heat)){
      map.removeLayer(heat);
      toggleHeatBtn.textContent='üî• Show Heatmap';
      toggleHeatBtn.classList.add('ghost');
    } else {
      map.addLayer(heat);
      toggleHeatBtn.textContent='üî• Hide Heatmap';
      toggleHeatBtn.classList.remove('ghost');
    }
  };

  // Initial load + auto-refresh
  fetchData();
  setInterval(fetchData, REFRESH_SECS*1000);
})();
</script>
</body>
</html>
