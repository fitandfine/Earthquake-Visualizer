<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>🌍 Earthquake Visualizer – Production</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    html,body{height:100%;margin:0}
    body{font-family:sans-serif;background:#0f172a;color:#e6eef8}
    .app{display:grid;grid-template-columns:1fr 320px;height:100vh;gap:12px;padding:12px;box-sizing:border-box}
    #map{width:100%;height:100%;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.6)}
    .sidebar{padding:16px;background:rgba(255,255,255,.05);border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.6);display:flex;flex-direction:column;gap:12px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,.2)}
    .stats{margin-top:auto;font-size:.9rem;opacity:.9}
    @media(max-width:900px){.app{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="app">
  <div id="map"></div>
  <aside class="sidebar">
    <h2>🌍 Earthquake Visualizer</h2>
    <p>Recent quakes from USGS. Marker size → magnitude, color → depth.</p>
    <div style="display:flex;gap:8px">
      <button id="refresh">🔄 Refresh</button>
      <button id="toggleHeat" class="ghost">🔥 Show Heatmap</button>
    </div>
    <div class="stats">
      Last updated: <span id="lastUpdated">—</span><br/>
      Earthquakes: <span id="count">—</span>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
(() => {
  const FEED='https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson';
  const REFRESH_SECS=60;
  const lastUpdated=document.getElementById('lastUpdated');
  const countSpan=document.getElementById('count');
  const refreshBtn=document.getElementById('refresh');
  const toggleHeat=document.getElementById('toggleHeat');

  let map=L.map('map',{preferCanvas:true,minZoom:2,worldCopyJump:true}).setView([20,0],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  let cluster=L.markerClusterGroup();
  let heat=L.heatLayer([], {radius:25,blur:20,maxZoom:6});
  map.addLayer(cluster);

  function depthColor(d){
    return d>300?'#8b00ff':d>70?'#ff6b00':d>20?'#ffbf00':'#00d084';
  }
  function magRadius(m){return Math.max(4,m*3);}
  function fmtTime(ms){return new Date(ms).toLocaleString();}

  async function fetchData(){
    try{
      lastUpdated.textContent='Fetching…';
      const res=await fetch(FEED);
      if(!res.ok)throw new Error(res.statusText);
      const {features}=await res.json();
      cluster.clearLayers();
      let heatPts=[],bounds=[];
      features.forEach(f=>{
        const [lon,lat,depth]=f.geometry.coordinates;
        const m=f.properties.mag??0;
        if(!lat||!lon)return;
        const c=L.circleMarker([lat,lon],{
          radius:magRadius(m),
          fillColor:depthColor(depth),
          color:'#000',weight:.3,fillOpacity:.85,opacity:.3
        }).bindPopup(
          `<strong>${f.properties.place}</strong><br>
           Mag: ${m} • Depth: ${depth}km<br>
           ${fmtTime(f.properties.time)}<br>
           <a href="${f.properties.url}" target="_blank">More</a>`
        );
        cluster.addLayer(c);
        heatPts.push([lat,lon,Math.min(1,Math.max(0.1,m/8))]);
        bounds.push([lat,lon]);
      });
      heat.setLatLngs(heatPts);
      countSpan.textContent=features.length;
      lastUpdated.textContent=new Date().toLocaleTimeString();
      if(bounds.length) map.fitBounds(bounds,{maxZoom:5,padding:[20,20]});
    }catch(e){
      console.error(e);
      lastUpdated.textContent='Error';
    }
  }

  refreshBtn.onclick=()=>fetchData();
  toggleHeat.onclick=()=>{
    if(map.hasLayer(heat)){
      map.removeLayer(heat);
      toggleHeat.textContent='🔥 Show Heatmap';
      toggleHeat.classList.add('ghost');
    }else{
      map.addLayer(heat);
      toggleHeat.textContent='🔥 Hide Heatmap';
      toggleHeat.classList.remove('ghost');
    }
  };

  fetchData();
  setInterval(fetchData,REFRESH_SECS*1000);
})();
</script>
</body>
</html>
